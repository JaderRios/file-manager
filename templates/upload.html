<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Subir archivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .archivos {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .archivo-cuadro {
            width: 150px;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .archivo-cuadro i {
            font-size: 3rem;
            margin-bottom: 5px;
        }
        .archivo-cuadro .nombre-archivo {
            font-size: 0.75rem;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .archivo-cuadro .archivo-info {
            font-size: 0.7rem;
            color: #555;
        }
        .archivo-pdf { background-color: #f8d7da; color: #d9534f; border-color: #d9534f; }
        .archivo-word { background-color: #d0e3ff; color: #0d6efd; border-color: #0d6efd; }
        .archivo-excel { background-color: #d4edda; color: #198754; border-color: #198754; }
        .archivo-otro { background-color: #e2e3e5; color: #495057; border-color: #ced4da; }
        .drop-zone {
            padding: 30px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
            background-color: #fafafa;
            cursor: pointer;
        }
        .drop-zone.dragover {
            background-color: #e9f7ef;
            border-color: #28a745;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">

    <h2 class="mb-4">Subir archivos</h2>

    {% if mensaje %}
        <div class="alert alert-success toast-message">{{ mensaje }}</div>
    {% endif %}

    <!-- Previews antes de subir -->
    <div id="previews" class="archivos"></div>

    <!-- Formulario con drag & drop -->
    <form id="uploadForm" action="/upload" enctype="multipart/form-data" method="post" class="mb-4 p-4 bg-white rounded shadow-sm">
        <div class="mb-3 drop-zone" id="dropZone">
            Arrastra tus archivos aquí o haz clic para seleccionar
            <input class="form-control" type="file" name="file" multiple required style="display:none;">
        </div>
        <button class="btn btn-success mt-3" type="submit">Subir</button>
        <div class="progress mt-2" style="height:5px; display:none;">
            <div class="progress-bar" role="progressbar" style="width:0%"></div>
        </div>
    </form>

    <h3>Archivos subidos:</h3>
    <div class="archivos">
        {% for archivo in archivos %}
            {% set ext = archivo.nombre.lower().split('.')[-1] %}
            {% if ext == "pdf" %}
                <a href="/{{ archivo.ruta }}" target="_blank" class="archivo-cuadro archivo-pdf">
                    <i class="bi bi-file-earmark-pdf"></i>
                    <span class="nombre-archivo">{{ archivo.nombre }}</span>
                </a>
            {% elif ext in ["doc","docx"] %}
                <a href="/{{ archivo.ruta }}" target="_blank" class="archivo-cuadro archivo-word">
                    <i class="bi bi-file-earmark-word"></i>
                    <span class="nombre-archivo">{{ archivo.nombre }}</span>
                </a>
            {% elif ext in ["xls","xlsx"] %}
                <a href="/{{ archivo.ruta }}" target="_blank" class="archivo-cuadro archivo-excel">
                    <i class="bi bi-file-earmark-spreadsheet"></i>
                    <span class="nombre-archivo">{{ archivo.nombre }}</span>
                </a>
            {% elif ext in ["png","jpg","jpeg","gif"] %}
                <a href="/{{ archivo.ruta }}" target="_blank" class="archivo-cuadro archivo-otro">
                    <img src="/{{ archivo.ruta }}" alt="{{ archivo.nombre }}" style="max-width:100%; max-height:70px; margin-bottom:5px;">
                    <span class="nombre-archivo">{{ archivo.nombre }}</span>
                </a>
            {% else %}
                <a href="/{{ archivo.ruta }}" target="_blank" class="archivo-cuadro archivo-otro">
                    <i class="bi bi-file-earmark"></i>
                    <span class="nombre-archivo">{{ archivo.nombre }}</span>
                </a>
            {% endif %}
        {% endfor %}
    </div>

</div>

<script>
    const dropZone = document.getElementById("dropZone");
    const fileInput = dropZone.querySelector("input[type=file]");
    const previewsContainer = document.getElementById("previews");

    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", e => {
        e.preventDefault();
        dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", e => {
        dropZone.classList.remove("dragover");
    });
    dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        fileInput.files = e.dataTransfer.files;
        mostrarPreviews(fileInput.files);
    });

    fileInput.addEventListener("change", () => {
        mostrarPreviews(fileInput.files);
    });

    function mostrarPreviews(files) {
        previewsContainer.innerHTML = ""; // Limpiar previews anteriores
        Array.from(files).forEach(file => {
            const ext = file.name.split('.').pop().toLowerCase();
            const cuadro = document.createElement("div");
            cuadro.className = "archivo-cuadro";

            if(ext === "pdf") cuadro.classList.add("archivo-pdf");
            else if(["doc","docx"].includes(ext)) cuadro.classList.add("archivo-word");
            else if(["xls","xlsx"].includes(ext)) cuadro.classList.add("archivo-excel");
            else cuadro.classList.add("archivo-otro");

            // Icono o thumbnail
            if(["png","jpg","jpeg","gif"].includes(ext)){
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.alt = file.name;
                img.style.maxWidth = "100%";
                img.style.maxHeight = "70px";
                img.style.marginBottom = "5px";
                cuadro.appendChild(img);
            } else {
                const icon = document.createElement("i");
                if(ext === "pdf") icon.className = "bi bi-file-earmark-pdf";
                else if(["doc","docx"].includes(ext)) icon.className = "bi bi-file-earmark-word";
                else if(["xls","xlsx"].includes(ext)) icon.className = "bi bi-file-earmark-spreadsheet";
                else icon.className = "bi bi-file-earmark";
                cuadro.appendChild(icon);
            }

            // Nombre y datos
            const nombre = document.createElement("span");
            nombre.className = "nombre-archivo";
            nombre.textContent = file.name;
            cuadro.appendChild(nombre);

            const info = document.createElement("span");
            info.className = "archivo-info";
            info.textContent = `${(file.size / 1024).toFixed(1)} KB • ${file.type || 'Desconocido'}`;
            cuadro.appendChild(info);

            previewsContainer.appendChild(cuadro);
        });
    }

    const toastMessage = document.querySelector(".toast-message");
    if(toastMessage){
        setTimeout(() => toastMessage.style.display = "none", 3000);
    }

    const form = document.getElementById("uploadForm");
    const progress = form.querySelector(".progress");
    const progressBar = progress.querySelector(".progress-bar");

    form.addEventListener("submit", e => {
        progress.style.display = "block";
        progressBar.style.width = "0%";
        let width = 0;
        const interval = setInterval(() => {
            if(width >= 100) clearInterval(interval);
            width += 10;
            progressBar.style.width = width + "%";
        }, 50);
    });
</script>

</body>
</html>
